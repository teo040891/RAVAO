<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£ng tr·ª±c ‚Äì ThƒÉm th√¢n</title>
  <style>
    body { font-family: system-ui, Arial; margin:0; background:#0b1220; color:#eaf0ff; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background:#111b31; border:1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 16px; }
    h1 { margin:0 0 8px; font-size: 18px; }
    .muted { color: rgba(234,240,255,.75); font-size: 13px; }
    input, button { padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background:#0b1220; color:#eaf0ff; }
    input { width: 100%; box-sizing: border-box; }
    button { cursor:pointer; font-weight:700; }
    button.primary { background:#1b74e4; border:0; }
    button.good { background:#0aa35c; border:0; }
    button.bad { background:#c0362c; border:0; }
    button.gray { background:#33415f; border:0; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom:1px solid rgba(255,255,255,.08); padding: 10px; vertical-align: top; font-size: 14px; }
    th { text-align:left; color: rgba(234,240,255,.85); }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .pending { background:#ffd86b; color:#2a1b00; }
    .approved { background:#68ffb3; color:#003018; }
    .rejected { background:#ff8f8f; color:#3b0000; }
    .out { background:#9bb1ff; color:#0b1220; }
    .row-actions button { margin-right: 6px; margin-top: 6px; }
    .topbar { display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
    .toast { margin-top: 10px; padding: 10px; border-radius: 10px; border:1px solid rgba(255,255,255,.12); background:#0b1220; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>B·∫£ng tr·ª±c ‚Äì ƒêƒÉng k√Ω thƒÉm th√¢n (T√äN ƒê∆†N V·ªä)</h1>
          <div class="muted">Trang n√†y c·∫≠p nh·∫≠t th·ªùi gian th·ª±c. Tr·ª±c ban b·∫•m duy·ªát ƒë·ªÉ cho v√†o. Ch·ªâ huy m·ªü trang n√†y ƒë·ªÉ theo d√µi.</div>
        </div>
        <div id="userBox" class="muted"></div>
      </div>

      <div id="loginBox" style="margin-top:12px;">
        <div class="grid">
          <div>
            <label class="muted">Email</label>
            <input id="email" placeholder="email tr·ª±c ban/ch·ªâ huy" />
          </div>
          <div>
            <label class="muted">M·∫≠t kh·∫©u</label>
            <input id="password" type="password" placeholder="********" />
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="primary" id="loginBtn">ƒêƒÇNG NH·∫¨P</button>
          <button class="gray" id="logoutBtn" style="display:none;">ƒêƒÇNG XU·∫§T</button>
          <label class="muted" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="soundToggle" checked />
            √Çm b√°o khi c√≥ ƒëƒÉng k√Ω m·ªõi
          </label>
          <label class="muted" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="notifToggle" />
            Th√¥ng b√°o tr√¨nh duy·ªát
          </label>
        </div>
        <div id="loginMsg" class="toast" style="display:none;"></div>
      </div>

      <div id="appBox" style="display:none; margin-top:12px;">
        <div id="stats" class="toast"></div>
        <div id="toast" class="toast" style="display:none;"></div>

        <table>
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Ng∆∞·ªùi thƒÉm</th>
              <th>Qu√¢n nh√¢n</th>
              <th>Quan h·ªá</th>
              <th>CCCD</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import {
    getFirestore, collection, query, where, orderBy, limit,
    onSnapshot, doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ====== firebaseConfig (GI·ªÆ NGUY√äN) ======
  const firebaseConfig = {
    apiKey: "AIzaSyAvKod7RAyvKE8w-w-NTUJlempsuxyRAsI",
    authDomain: "thamthan584.firebaseapp.com",
    projectId: "thamthan584",
    storageBucket: "thamthan584.firebasestorage.app",
    messagingSenderId: "1072621285684",
    appId: "1:1072621285684:web:b5b64b288aecbbb85cb561"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const loginBox = document.getElementById("loginBox");
  const appBox = document.getElementById("appBox");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginMsg = document.getElementById("loginMsg");
  const userBox = document.getElementById("userBox");
  const tbody = document.getElementById("tbody");
  const stats = document.getElementById("stats");
  const toast = document.getElementById("toast");
  const soundToggle = document.getElementById("soundToggle");
  const notifToggle = document.getElementById("notifToggle");

  function showLoginMsg(text) {
    loginMsg.style.display = "block";
    loginMsg.innerHTML = text;
  }
  function hideLoginMsg() { loginMsg.style.display = "none"; }

  function showToast(text) {
    toast.style.display = "block";
    toast.innerHTML = text;
    setTimeout(() => toast.style.display = "none", 6000);
  }

  async function beep() {
    if (!soundToggle.checked) return;
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.start();
      o.stop(ctx.currentTime + 0.18);
      o.onended = () => ctx.close();
    } catch {}
  }

  async function ensureNotifPermission() {
    if (!notifToggle.checked) return false;
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    const p = await Notification.requestPermission();
    return p === "granted";
  }

  // Login/Logout
  loginBtn.addEventListener("click", async () => {
    hideLoginMsg();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      showLoginMsg(`<b>ƒêƒÉng nh·∫≠p l·ªói:</b> ${e.message}`);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Realtime listener
  let unsub = null;
  let knownIds = new Set();

  function formatTime(ts) {
    if (!ts) return "-";
    const d = ts.toDate ? ts.toDate() : ts;
    return d.toLocaleString("vi-VN");
  }

  function statusPill(s) {
    if (s === "pending") return `<span class="pill pending">CH·ªú DUY·ªÜT</span>`;
    if (s === "approved") return `<span class="pill approved">ƒê√É DUY·ªÜT</span>`;
    if (s === "rejected") return `<span class="pill rejected">T·ª™ CH·ªêI</span>`;
    if (s === "checked_out") return `<span class="pill out">ƒê√É V·ªÄ</span>`;
    return s;
  }

  function renderRows(rows) {
    tbody.innerHTML = rows.map(r => {
      const cccdMasked = `****${r.cccdLast4 || ""}`;
      const actions = (r.status === "pending") ? `
        <button class="good" data-act="approve" data-id="${r.id}">DUY·ªÜT</button>
        <button class="bad" data-act="reject" data-id="${r.id}">T·ª™ CH·ªêI</button>
      ` : (r.status === "approved") ? `
        <button class="gray" data-act="manualCheckout" data-id="${r.id}">CHECK-OUT TH·ª¶ C√îNG</button>
      ` : `
        <span class="muted">-</span>
      `;

      return `
        <tr>
          <td>${formatTime(r.createdAt)}</td>
          <td>
            <b>${r.fullName}</b><br>
            <span class="muted">${r.phone}</span>
          </td>
          <td>${r.soldierName}</td>
          <td>${r.relationship}</td>
          <td>${cccdMasked}</td>
          <td>${statusPill(r.status)}</td>
          <td class="row-actions">${actions}</td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const ref = doc(db, "visits", id);

        try {
          if (act === "approve") {
            await updateDoc(ref, {
              status: "approved",
              approvedAt: serverTimestamp(),
              approvedBy: auth.currentUser.uid
            });
            showToast("‚úÖ ƒê√£ duy·ªát cho v√†o.");
          }
          if (act === "reject") {
            await updateDoc(ref, {
              status: "rejected",
              approvedAt: serverTimestamp(),
              approvedBy: auth.currentUser.uid
            });
            showToast("‚õî ƒê√£ t·ª´ ch·ªëi.");
          }
          if (act === "manualCheckout") {
            await updateDoc(ref, {
              status: "checked_out",
              checkoutAt: serverTimestamp(),
              checkoutMethod: "manual"
            });
            showToast("üèÅ ƒê√£ check-out th·ªß c√¥ng.");
          }
        } catch (e) {
          showToast(`‚ùå L·ªói thao t√°c: ${e.message}`);
        }
      });
    });
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      userBox.textContent = "";
      appBox.style.display = "none";
      logoutBtn.style.display = "none";
      loginBtn.style.display = "inline-block";
      if (unsub) { unsub(); unsub = null; }
      knownIds = new Set();
      return;
    }

    userBox.innerHTML = `ƒêƒÉng nh·∫≠p: <b>${user.email}</b>`;
    logoutBtn.style.display = "inline-block";
    loginBtn.style.display = "none";
    appBox.style.display = "block";
    showToast("ƒê√£ ƒëƒÉng nh·∫≠p. ƒêang b·∫≠t realtime...");

    notifToggle.addEventListener("change", ensureNotifPermission);
    await ensureNotifPermission();

    const start = new Date();
    start.setHours(0,0,0,0);

    const q = query(
      collection(db, "visits"),
      where("createdAt", ">=", start),
      orderBy("createdAt", "desc"),
      limit(200)
    );

    unsub = onSnapshot(q, async (snap) => {
      const rows = [];
      let countPending = 0, countApproved = 0, countOut = 0, countRejected = 0;

      for (const ch of snap.docChanges()) {
        if (ch.type === "added") {
          const d = ch.doc.data();
          if (!knownIds.has(ch.doc.id)) {
            knownIds.add(ch.doc.id);
            if (d.status === "pending") {
              await beep();
              if (notifToggle.checked && "Notification" in window && Notification.permission === "granted") {
                new Notification("C√≥ ƒëƒÉng k√Ω thƒÉm th√¢n m·ªõi", {
                  body: `${d.fullName || "M·ªôt ng∆∞·ªùi"} ‚Äì thƒÉm ${d.soldierName || ""}`
                });
              }
              showToast(`üì£ M·ªõi: ${d.fullName} ƒëƒÉng k√Ω thƒÉm ${d.soldierName}`);
            }
          }
        }
      }

      snap.forEach(docSnap => {
        const d = docSnap.data();
        const item = { id: docSnap.id, ...d };
        rows.push(item);

        if (d.status === "pending") countPending++;
        else if (d.status === "approved") countApproved++;
        else if (d.status === "checked_out") countOut++;
        else if (d.status === "rejected") countRejected++;
      });

      stats.innerHTML = `
        <b>T·ªïng h√¥m nay:</b> ${rows.length} ‚Äî
        <span class="pill pending">Ch·ªù duy·ªát: ${countPending}</span>
        <span class="pill approved">ƒê√£ duy·ªát: ${countApproved}</span>
        <span class="pill out">ƒê√£ v·ªÅ: ${countOut}</span>
        <span class="pill rejected">T·ª´ ch·ªëi: ${countRejected}</span>
      `;
      renderRows(rows);
    }, (err) => {
      showToast(`‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu (Rules/Quy·ªÅn?): ${err.message}`);
    });
  });
</script>
</body>
</html>

