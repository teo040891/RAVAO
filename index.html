<script type="module">
  // ====== 1) IMPORT FIREBASE SDK (CDN) ======
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ====== 2) firebaseConfig (GIỮ NGUYÊN) ======
  const firebaseConfig = {
    apiKey: "AIzaSyAvKod7RAyvKE8w-w-NTUJlempsuxyRAsI",
    authDomain: "thamthan584.firebaseapp.com",
    projectId: "thamthan584",
    storageBucket: "thamthan584.firebasestorage.app",
    messagingSenderId: "1072621285684",
    appId: "1:1072621285684:web:b5b64b288aecbbb85cb561"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ====== 3) TIỆN ÍCH: HASH CCCD (SHA-256 -> HEX) ======
  async function sha256Hex(text) {
    const enc = new TextEncoder().encode(text);
    const hashBuf = await crypto.subtle.digest("SHA-256", enc);
    const hashArr = Array.from(new Uint8Array(hashBuf));
    return hashArr.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // ====== 4) COOKIE + LOCALSTORAGE ======
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
  }
  function showMsg(type, html) {
    const el = document.getElementById("msg");
    el.innerHTML = `<div class="${type}">${html}</div>`;
  }

  // ====== 5) SUBMIT FORM ======
  const form = document.getElementById("form");
  const submitBtn = document.getElementById("submitBtn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    showMsg("muted", "Đang gửi đăng ký...");

    try {
      const fullName = document.getElementById("fullName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const relationship = document.getElementById("relationship").value.trim();
      const soldierName = document.getElementById("soldierName").value.trim();
      const cccdRaw = document.getElementById("cccd").value.trim().replace(/\s+/g, "");

      if (!/^\d{12}$/.test(cccdRaw)) throw new Error("CCCD phải đúng 12 chữ số.");

      const cccdLast4 = cccdRaw.slice(-4);
      const cccdHash = await sha256Hex(cccdRaw);

      const visitRef = await addDoc(collection(db, "visits"), {
        fullName, phone, relationship, soldierName,
        cccdLast4, cccdHash,
        status: "pending",
        createdAt: serverTimestamp(),
        approvedAt: null,
        approvedBy: null,
        checkoutAt: null,
        checkoutMethod: null
      });

      await setDoc(doc(db, "activeByCccd", cccdHash), {
        visitId: visitRef.id,
        updatedAt: serverTimestamp()
      }, { merge: true });

      localStorage.setItem("visitId", visitRef.id);
      localStorage.setItem("cccdHash", cccdHash);
      setCookie("visitId", visitRef.id, 3);
      setCookie("cccdHash", cccdHash, 3);

      showMsg("ok", `<b>Đăng ký thành công!</b><br>Vui lòng chờ Trực ban duyệt và mời vào đơn vị.`);
      form.reset();
    } catch (err) {
      showMsg("err", `<b>Lỗi:</b> ${err.message || err}`);
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
